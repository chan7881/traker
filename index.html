<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Motion Tracker (YOLO ONNX)</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="app">
    <header>
      <h1>Motion Tracker</h1>
      <p class="subtitle">동영상에서 물체를 지정해 운동을 분석합니다. (모바일 지원)</p>
    </header>

    <section class="controls">
      <div class="tabs">
        <button id="stepCamera" class="tab active">1. 촬영</button>
        <button id="stepExtract" class="tab">2. 프레임 추출</button>
        <button id="stepROI" class="tab">3. ROI 선택</button>
        <button id="stepAnalyze" class="tab">4. 결과</button>
      </div>

      <div class="tab-content" id="tab-1">
        <div class="row">
          <label class="file-btn">파일 업로드<input id="videoFile" type="file" accept="video/*" /></label>
          <button id="startCamera">카메라 켜기</button>
          <button id="recordToggle" disabled style="display:none">녹화 시작</button>
        </div>
        <div class="hint">카메라로 촬영하거나 비디오 파일을 업로드하세요.</div>
      </div>

      <div class="tab-content" id="tab-2" style="display:none">
        <div class="row small">
          <label>FPS: <input id="fpsInput" type="number" value="10" min="1" max="60"></label>
          <label>신뢰도: <input id="confInput" type="number" value="0.3" step="0.05" min="0" max="1"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="extractFramesBtn" class="big">프레임 추출 시작</button>
        </div>
        <div id="extractProgress" style="flex:1;display:none;margin-top:8px">
          <div style="background:#123;height:12px;border-radius:6px;overflow:hidden"><div id="progressBar" style="background:#4fd1c5;height:100%;width:0%"></div></div>
          <div class="hint" id="progressText">0%</div>
        </div>
        <div class="row frame-nav" style="display:none;align-items:center;gap:8px;margin-top:8px">
          <button id="prevFrame">◀</button>
          <div id="frameIdx" class="hint">Frame 0 / 0</div>
          <button id="nextFrame">▶</button>
          <button id="frameROI" class="small">이 프레임 ROI 선택</button>
        </div>
      </div>

      <div class="tab-content" id="tab-3" style="display:none">
        <div class="hint">각 프레임을 확인하며 ROI를 지정하세요. 지정한 프레임은 목록에 저장됩니다.</div>
        <div class="row" style="margin-top:8px">
          <button id="completeROIs" class="big">ROI 선택 완료 (자동 분석 실행)</button>
        </div>
      </div>

      <div class="tab-content" id="tab-4" style="display:none">
        <div class="row" style="margin-bottom:8px">
          <button id="playResultsBtn" class="big">결과 재생</button>
          <button id="exportCSV">CSV 내보내기</button>
        </div>
        <div id="charts">
          <canvas id="posChart"></canvas>
          <canvas id="velChart"></canvas>
        </div>
      </div>

      <div class="row small">
        <label>FPS: <input id="fpsInput" type="number" value="30" min="1" max="240"></label>
        <label>신뢰도 임계값: <input id="confInput" type="number" value="0.3" step="0.05" min="0" max="1"></label>
        <label>스케일(픽셀→실제): <input id="scaleInput" type="number" value="1" step="0.01"></label>
      </div>
      <div class="row">
        <div id="status" class="hint">모델 로드 상태: 대기 중...</div>
      </div>
    </section>

    <section class="workspace">
      <div class="video-wrap">
        <video id="video" playsinline controls></video>
        <canvas id="overlay"></canvas>
      </div>

      <aside class="analysis">
        <h3>분석</h3>
        <div id="charts">
          <canvas id="posChart"></canvas>
          <canvas id="velChart"></canvas>
        </div>
      </aside>
    </section>

    <footer>
      <small>모델 파일은 프로젝트 루트에 있는 <code>yolov8n.onnx</code>를 사용합니다. 로컬에서 실행할 때는 간단한 HTTP 서버로 제공하세요 (예: <code>python -m http.server</code>).</small>
    </footer>
  </main>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
